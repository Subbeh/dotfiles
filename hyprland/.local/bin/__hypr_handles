#!/bin/bash

dynamic_window_layout() {
  local profile="$(hypr_reload.py -l | awk '/ACTIVE/{print $1}')"
  echo "INFO: monitor profile: $profile"
  if [[ "$profile" ]] && [[ "$profile" == "ext" ]]; then
    local active_workspace=$(hyprctl activewindow -j 2>/dev/null | jq -r '.workspace.id // empty' 2>/dev/null || echo "")
    [[ "$active_workspace" != "1" ]] && return

    local workspace_info=$(hyprctl workspaces -j 2>/dev/null | jq '.[] | select(.id == 1)' 2>/dev/null || echo "")
    [[ -z "$workspace_info" ]] && return

    local monitor_name=$(echo "$workspace_info" | jq -r '.monitor' 2>/dev/null || echo "")
    [[ -z "$monitor_name" || "$monitor_name" == "null" ]] && return

    local monitor_info=$(hyprctl monitors -j 2>/dev/null | jq --arg name "$monitor_name" '.[] | select(.name == $name)' 2>/dev/null || echo "")

    local windows_count=$(echo "$workspace_info" | jq -r '.windows // 0' 2>/dev/null || echo "0")
    if [[ "$windows_count" -eq 1 ]]; then
      local screen_width=$(echo "$monitor_info" | jq -r '.width // 0' 2>/dev/null || echo "0")
      [[ "$screen_width" -le 0 ]] && return
      local reserved_width=$((screen_width * 40 / 100))

      # Add 40% reserved space on the left
      hyprctl keyword monitor "$monitor_name,addreserved,0,0,$reserved_width,0" >/dev/null 2>&1
    else
      # Remove reserved space
      hyprctl keyword monitor "$monitor_name,addreserved,0,0,0,0" >/dev/null 2>&1
    fi
  fi
}

handle() {
  case $1 in
    windowtitle*)
      # Extract the window ID from the line
      window_id=${1#*>>}

      # Fetch the list of windows and parse it using jq to find the window by its decimal ID
      window_info=$(hyprctl clients -j | jq --arg id "0x$window_id" '.[] | select(.address == ($id))')

      # Extract the title from the window info
      window_title=$(echo "$window_info" | jq '.title')

      # Check if the title matches the characteristics of the Bitwarden popup window
      case "$window_title" in
        *"Extension: (Bitwarden Password Manager) - Bitwarden â€” Mozilla Firefox"*)
          hyprctl --batch "dispatch togglefloating address:0x$window_id ; dispatch resizewindowpixel exact 20% 40%,address:0x$window_id ; dispatch movewindowpixel exact 40% 30%,address:0x$window_id"
          ;;
      esac
      ;;
    openwindow* | closewindow* | movewindow* | changefloatingmode*) dynamic_window_layout ;;
  esac
}

# Listen to the Hyprland socket for events and process each line with the handle function
socat -U - UNIX-CONNECT:"$XDG_RUNTIME_DIR/hypr/$HYPRLAND_INSTANCE_SIGNATURE/.socket2.sock" | while read -r line; do handle "$line"; done
