#!/usr/bin/env bash

# Waybar monitor configuration script
# Manages waybar display based on connected monitors

set -euo pipefail

# Configuration
CONFIG_TMPL="${XDG_CONFIG_HOME:-$HOME/.config}/waybar/config.tmpl"
CONFIG="${XDG_CACHE_HOME:-$HOME/.cache}/waybar_config.json"
LOCK_FILE="/tmp/hypr_reload.lock"
LOCK_FD=200

# Logging
log_info() {
  echo "[hypr_reload] INFO: $*" >&2
}

log_error() {
  echo "[hypr_reload] ERROR: $*" >&2
}

# Lock management to prevent concurrent executions
acquire_lock() {
  eval "exec $LOCK_FD>$LOCK_FILE"
  if ! flock -n $LOCK_FD; then
    log_info "Another instance is running, waiting..."
    flock -w 5 $LOCK_FD || {
      log_error "Failed to acquire lock after 5 seconds"
      exit 1
    }
  fi
}

release_lock() {
  flock -u $LOCK_FD 2>/dev/null || true
}

# Cleanup on exit
cleanup() {
  release_lock
}

trap cleanup EXIT INT TERM

# Determine the main monitor based on connected monitors
get_main_monitor() {
  local monitors count

  # Get monitor data from hyprctl
  if ! monitors=$(hyprctl monitors -j 2>/dev/null); then
    log_error "Failed to get monitor information from hyprctl"
    return 1
  fi

  count=$(echo "$monitors" | jq 'length')

  case "$count" in
    1)
      # Single monitor - use internal display
      echo "eDP-1"
      ;;
    2)
      # Two monitors (laptop + 1 external) - use the external monitor
      # Find the monitor that is NOT eDP-1
      local external_monitor
      external_monitor=$(echo "$monitors" | jq -r '.[] | select(.name != "eDP-1") | .name' | head -1)

      if [[ -n "$external_monitor" ]]; then
        echo "$external_monitor"
      else
        # Fallback to eDP-1 if we can't find external
        log_error "Could not find external monitor, falling back to eDP-1"
        echo "eDP-1"
      fi
      ;;
    3)
      # Three monitors (laptop + 2 external) - use LG HDR 4K as primary
      local lg_monitor
      lg_monitor=$(echo "$monitors" | jq -r '.[] | select(.description == "LG Electronics LG HDR 4K 308NTTQFK265") | .name')

      if [[ -n "$lg_monitor" ]]; then
        echo "$lg_monitor"
      else
        # Fallback: use first non-eDP-1 monitor
        local fallback_monitor
        fallback_monitor=$(echo "$monitors" | jq -r '.[] | select(.name != "eDP-1") | .name' | head -1)

        if [[ -n "$fallback_monitor" ]]; then
          log_error "LG HDR 4K not found, using fallback: $fallback_monitor"
          echo "$fallback_monitor"
        else
          log_error "No suitable monitor found, falling back to eDP-1"
          echo "eDP-1"
        fi
      fi
      ;;
    *)
      # More than 3 monitors or no monitors - default to eDP-1
      log_error "Unexpected monitor count: $count, falling back to eDP-1"
      echo "eDP-1"
      ;;
  esac
}

# Main function
main() {
  # Acquire lock to prevent concurrent executions
  acquire_lock

  # Validate template exists
  if [[ ! -f "$CONFIG_TMPL" ]]; then
    log_error "Waybar config template not found: $CONFIG_TMPL"
    exit 1
  fi

  # Get the main monitor
  local main_mon
  if ! main_mon=$(get_main_monitor); then
    log_error "Failed to determine main monitor"
    exit 1
  fi

  log_info "Using monitor: $main_mon"

  # Generate waybar config from template
  if ! sed "s/@@OUTPUT@@/$main_mon/" "$CONFIG_TMPL" > "$CONFIG"; then
    log_error "Failed to generate waybar config"
    exit 1
  fi

  log_info "Generated waybar config: $CONFIG"

  # Reload or start waybar
  if pgrep -x waybar &>/dev/null; then
    log_info "Reloading waybar..."
    if killall -SIGUSR2 waybar 2>/dev/null; then
      log_info "Waybar reloaded successfully"
    else
      log_error "Failed to reload waybar, trying restart..."
      killall waybar 2>/dev/null || true
      sleep 0.5
      waybar -c "$CONFIG" &>/dev/null &
      log_info "Waybar restarted"
    fi
  else
    log_info "Starting waybar..."
    waybar -c "$CONFIG" &>/dev/null &
    log_info "Waybar started"
  fi
}

main "$@"
